<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <title>Many to many</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script>
  
  const count = 25;
  var index = 0;
  var characters = [];
  var items = [];
  var curId = 0;
  var sortedByName = true;
  var sortedByClass = false;
  var sortedByRace = false;
  var nameDown = false;
  var raceDown = false;
  var classDown = false;

  renderTable(index, count);

  function next(){
      index += count;
      getSortedTable(index, count);
  }

  function previous(){
      index -= count;
      if(index < 0){index = 0;}
      getSortedTable(index, count);
  }

  function create_UUID(){
      var dt = new Date().getTime();
      var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = (dt + Math.random()*16)%16 | 0;
          dt = Math.floor(dt/16);
          return (c=='x' ? r :(r&0x3|0x8));
      });
      uuid = uuid.replace("-","3");
      return uuid;
  }

  function renderEdit(editIdx){
    $("#overlay").show();
    $("#edit").show();
    var character = characters[editIdx];
    $("#pname").val(character.pname);
    $("#race").val(character.race);
    $("#guild").val(character.guild);
    curId = character.id
    $.post("/caleb/api.php/item/readItems", function(data, status){
      if(status == "success"){
        $.each(JSON.parse(data), function(index, item){
          $('#itemList').append('<option value="'+item.id+'">'+item.iname+'</option>');
        });
      }
    });
  }
  function renderItemEdit(ieditIdx){
    $("#overlay").show();
    $("#editItem").show();
    var item = items[ieditIdx];
    $("#iname").val(item.iname);
    curId = item.id;
  }
  function closeEdit(){
    $("#overlay").hide();
    $("#edit").hide();
    $("#editItem").hide();
    $("#createPerson").hide();
    $("#createItm").hide();
    $("#readCharacter").hide();
    $('#charItems').remove();
  }
  function save(){
    var selectBox = document.getElementById("itemList");
    var selectedValue = selectBox.options[selectBox.selectedIndex].value;
    let saveobj = {
      'pname': $("#pname").val(),
      'race': $("#race").val(),
      'guild': $("#guild").val(),
      'id': curId,
      'item': selectedValue
    }
    $.post("/caleb/api.php/character/update/", saveobj, function(data, status){
      if(status == "success"){
        $("#message").val("Saved");
        renderTable(index, count);
        closeEdit();
      }
    });
  }
  function saveItem(){

    $.getJSON("/caleb/api.php/item/update/?iname="+$("#iname").val()+"&id="+curId, function(data, status){
      if(status == "success"){
        $("#imessage").val("Saved");
        renderItemTable();
        closeEdit();
      }
    });
  }

  function deleteCharacter(id){
    $.getJSON("/caleb/api.php/character/delete/?id="+id, function(data,status){
      if(status == "success"){
        renderTable(index, count);
      }
    });
  }
  function deleteItem(id){
    
    $.getJSON("/caleb/api.php/item/delete/?id="+id, function(data, status){
      if(status == "success"){
        renderItemTable();
      }
    });
  }
  function createCharacter(){
    $("#overlay").show();
    $("#createPerson").show();
    curId = create_UUID();
    $.post("/caleb/api.php/item/readItems", function(data, status){
      if(status == "success"){
        $.each(JSON.parse(data), function(index, item){
          $('#items').append('<option value="'+item.id+'">'+item.iname+'</option>');
        });
      }
    });
  }
  function createItm(){
    $("#overlay").show();
    $("#createItm").show();
    curId = create_UUID();
  }
  function create(){
    var selectBox = document.getElementById("items");
    var selectedValue = selectBox.options[selectBox.selectedIndex].value;
    let saveobj = {
      'pname': $("#cpname").val(),
      'race': $("#crace").val(),
      'guild': $("#cguild").val(),
      'id': curId,
      'item': selectedValue
    }
    $.post("/caleb/api.php/character/create/", saveobj, function(data, status){
      if(status == "success"){
        $("#message").val("Saved");
        renderTable(index, count);
        closeEdit();
      }
    });
  }
  function createItem(){
    $.getJSON("/caleb/api.php/item/create/?iname="+$("#ciname").val()+"&id="+curId, function(data, status){
      if(status == "success"){
        $("#imessage").val("Saved");
        renderItemTable();
        closeEdit();
      }
    });
  }
  function readCharacter(idx ,id){
    $.getJSON("/caleb/api.php/character/read/?id="+id, function(data,status){
      if(status == "success"){
        $("#rpname").text('Name: '+characters[idx].pname);
        $("#rrace").text('Race: '+characters[idx].race);
        $("#rguild").text('Class: '+characters[idx].guild);
        var items;
        $.each(data, function(index, item){
          if(item == null){
            return false;
          }
          items += '<label>'+item.iname+', </label> ';
        });
        $("#charItms").append(items);
        $('#readCharacter').show();
        $("#overlay").show();
      }
    });
  }

  function sortByName(){
    index = 0;
    if(sortedByName == true){
      sortedByName = false;
      sortedByRace = false;
      sortedByClass = false;
      nameDown = true;
      raceDown = false;
      classDown = false;
      getSortedTable()
    }
    else{
      sortedByName = true;
      sortedByRace = false;
      sortedByClass = false;
      nameDown = true;
      raceDown = false;
      classDown = false;
      getSortedTable();
    }
  }
  function sortByRace(idx=0, cnt=25){
    index = 0;
    if(sortedByRace == true){
      sortedByName = false;
      sortedByRace = false;
      sortedByClass = false;
      nameDown = false;
      raceDown = true;
      classDown = false;
      getSortedTable();
    }
    else{
      sortedByName = false;
      sortedByRace = true;
      sortedByClass = false;
      nameDown = false;
      raceDown = false;
      classDown = false;
      getSortedTable();
    }
  }
  
  function sortByClass(idx=0, cnt=25){
    index = 0;
    if(sortedByClass == true){
      sortedByName = false;
      sortedByRace = false;
      sortedByClass = false;
      nameDown = false;
      raceDown = false;
      classDown = true;
      getSortedTable();
    }
    else{
      sortedByName = false;
      sortedByRace = false;
      sortedByClass = true;
      nameDown = false;
      raceDown = false;
      classDown = false;
      getSortedTable();
    }
  }
  
function getSortedTable(idx = 0, cnt = 25){
  if(sortedByName == true){
    renderTable(idx,cnt);
  }
  else if(nameDown == true){
    $.getJSON("/caleb/api.php/character/sortCharDown/?idx="+idx+"&cnt="+ cnt , function(data, status){
          if (status == "success"){
            characters = data;
              var rows = '<tr><th><button onclick="sortByName()">Name</button><div id="charUp"></div><div id="charDown"></div></th><th><button onclick="sortByRace()">Race</button><div id="raceUp"></div><div id="raceDown"></div></th><th><button onclick="sortByClass()">Class</button><div id="classUp"></div><div id="classDown"></div></th></tr>';
              $.each (data, function(index, item){
                rows += '<tr><td><button onclick="readCharacter('+index+','+item.id+')">' + item.pname + '</button></td><td>' + item.race + '</td><td>' + item.guild + '</td><td><button onclick="renderEdit('+ index +')">Edit</button></td><td><button onclick="deleteCharacter('+ item.id +')">delete</button></td></tr>';
              });
              $('#ctab').html(rows);
              $('#itemNumbers').html((idx+1) + '-' + (idx + cnt));
              $('#buttonWrapper').show();
              $('#create').show();
              $('#createItem').hide();
              $('#editItem').hide();
              $('#createPerson').hide();
              $('#createItm').hide();
              $('#readCharacter').hide();
              $('#charUp').hide();
              $('#charDown').show();
              $('#raceUp').hide();
              $('#raceDown').hide();
              $('#classUp').hide();
              $('#classDown').hide();
          }
      });

  }
  else if(raceDown == true){
    $.getJSON("/caleb/api.php/character/sortRaceDown/?idx="+idx+"&cnt="+ cnt , function(data, status){
          if (status == "success"){
            characters = data;
              var rows = '<tr><th><button onclick="sortByName()">Name</button><div id="charUp"></div><div id="charDown"></div></th><th><button onclick="sortByRace()">Race</button><div id="raceUp"></div><div id="raceDown"></div></th><th><button onclick="sortByClass()">Class</button><div id="classUp"></div><div id="classDown"></div></th></tr>';
              $.each (data, function(index, item){
                rows += '<tr><td><button onclick="readCharacter('+index+','+item.id+')">' + item.pname + '</button></td><td>' + item.race + '</td><td>' + item.guild + '</td><td><button onclick="renderEdit('+ index +')">Edit</button></td><td><button onclick="deleteCharacter('+ item.id +')">delete</button></td></tr>';
              });
              $('#ctab').html(rows);
              $('#itemNumbers').html((idx+1) + '-' + (idx + cnt));
              $('#buttonWrapper').show();
              $('#create').show();
              $('#createItem').hide();
              $('#editItem').hide();
              $('#createPerson').hide();
              $('#createItm').hide();
              $('#readCharacter').hide();
              $("#charUp").hide();
              $("#charDown").hide();
              $("#raceUp").hide();
              $("#raceDown").show();
              $("#classUp").hide();
              $("#classDown").hide();
          }
      });
   
  }
  else if(sortedByRace == true){
    $.getJSON("/caleb/api.php/character/sortRaceUp/?idx="+idx+"&cnt="+ cnt , function(data, status){
          if (status == "success"){
            characters = data;
              var rows = '<tr><th><button onclick="sortByName()">Name</button><div id="charUp"></div><div id="charDown"></div></th><th><button onclick="sortByRace()">Race</button><div id="raceUp"></div><div id="raceDown"></div></th><th><button onclick="sortByClass()">Class</button><div id="classUp"></div><div id="classDown"></div></th></tr>';
              $.each (data, function(index, item){
                rows += '<tr><td><button onclick="readCharacter('+index+','+item.id+')">' + item.pname + '</button></td><td>' + item.race + '</td><td>' + item.guild + '</td><td><button onclick="renderEdit('+ index +')">Edit</button></td><td><button onclick="deleteCharacter('+ item.id +')">delete</button></td></tr>';
              });
              $('#ctab').html(rows);
              $('#itemNumbers').html((idx+1) + '-' + (idx + cnt));
              $('#buttonWrapper').show();
              $('#create').show();
              $('#createItem').hide();
              $('#editItem').hide();
              $('#createPerson').hide();
              $('#createItm').hide();
              $('#readCharacter').hide();
              $("#charUp").hide();
              $("#charDown").hide();
              $("#raceUp").show();
              $("#raceDown").hide();
              $("#classUp").hide();
              $("#classDown").hide();
          }
      });

  }
  else if(sortedByClass == true){
    $.getJSON("/caleb/api.php/character/sortClassUp/?idx="+idx+"&cnt="+ cnt , function(data, status){
          if (status == "success"){
            characters = data;
              var rows = '<tr><th><button onclick="sortByName()">Name</button><div id="charUp"></div><div id="charDown"></div></th><th><button onclick="sortByRace()">Race</button><div id="raceUp"></div><div id="raceDown"></div></th><th><button onclick="sortByClass()">Class</button><div id="classUp"></div><div id="classDown"></div></th></tr>';
              $.each (data, function(index, item){
                rows += '<tr><td><button onclick="readCharacter('+index+','+item.id+')">' + item.pname + '</button></td><td>' + item.race + '</td><td>' + item.guild + '</td><td><button onclick="renderEdit('+ index +')">Edit</button></td><td><button onclick="deleteCharacter('+ item.id +')">delete</button></td></tr>';
              });
              $('#ctab').html(rows);
              $('#itemNumbers').html((idx+1) + '-' + (idx + cnt));
              $('#buttonWrapper').show();
              $('#create').show();
              $('#createItem').hide();
              $('#editItem').hide();
              $('#createPerson').hide();
              $('#createItm').hide();
              $('#readCharacter').hide();
              $("#charUp").hide();
              $("#charDown").hide();
              $("#raceUp").hide();
              $("#raceDown").hide();
              $("#classUp").show();
              $("#classDown").hide();
          }
      });
  }
  else if(classDown == true){
    $.getJSON("/caleb/api.php/character/sortClassDown/?idx="+idx+"&cnt="+ cnt , function(data, status){
          if (status == "success"){
            characters = data;
              var rows = '<tr><th><button onclick="sortByName()">Name</button><div id="charUp"></div><div id="charDown"></div></th><th><button onclick="sortByRace()">Race</button><div id="raceUp"></div><div id="raceDown"></div></th><th><button onclick="sortByClass()">Class</button><div id="classUp"></div><div id="classDown"></div></th></tr>';
              $.each (data, function(index, item){
                rows += '<tr><td><button onclick="readCharacter('+index+','+item.id+')">' + item.pname + '</button></td><td>' + item.race + '</td><td>' + item.guild + '</td><td><button onclick="renderEdit('+ index +')">Edit</button></td><td><button onclick="deleteCharacter('+ item.id +')">delete</button></td></tr>';
              });
              $('#ctab').html(rows);
              $('#itemNumbers').html((idx+1) + '-' + (idx + cnt));
              $('#buttonWrapper').show();
              $('#create').show();
              $('#createItem').hide();
              $('#editItem').hide();
              $('#createPerson').hide();
              $('#createItm').hide();
              $('#readCharacter').hide();
              $("#charUp").hide();
              $("#charDown").hide();
              $("#raceUp").hide();
              $("#raceDown").hide();
              $("#classUp").hide();
              $("#classDown").show();
          }
      });
  }
}

  function renderTable(idx, cnt){
        
    $.getJSON("/caleb/api.php/character/readCharacters/?idx="+idx+"&cnt="+ cnt , function(data, status){
          if (status == "success"){
            characters = data;
              var rows = '<tr><th><button onclick="sortByName()">Name</button><div id="charUp"></div><div id="charDown"></div></th><th><button onclick="sortByRace()">Race</button><div id="raceUp"></div><div id="raceDown"></div></th><th><button onclick="sortByClass()">Class</button><div id="classUp"></div><div id="classDown"></div></th></tr>';
              $.each (data, function(index, item){
                rows += '<tr><td><button onclick="readCharacter('+index+','+item.id+')">' + item.pname + '</button></td><td>' + item.race + '</td><td>' + item.guild + '</td><td><button onclick="renderEdit('+ index +')">Edit</button></td><td><button onclick="deleteCharacter('+ item.id +')">delete</button></td></tr>';
              });
              $('#ctab').html(rows);
              $('#itemNumbers').html((idx+1) + '-' + (idx + cnt));
              $('#buttonWrapper').show();
              $('#create').show();
              $('#createItem').hide();
              $('#editItem').hide();
              $('#createPerson').hide();
              $('#createItm').hide();
              $('#readCharacter').hide();
              $('#charDown').hide();
              $('#raceUp').hide();
              $('#raceDown').hide();
              $('#classUp').hide();
              $('#classDown').hide();
          }
      });

      
    }
  function renderItemTable(){
    $.getJSON("/caleb/api.php/item/readItems" , function(data,status){
      if(status == "success"){
        items = data;
        var rows = '<tr><th>Items</th></tr>';
        $.each (data, function(index, item){
          rows += '<tr><td>' + item.iname +'</td><td><button onclick="renderItemEdit('+ index +')">Edit</button></td><td><button onclick="deleteItem('+ item.id +')">delete</button></td></tr>';
        });
        $('#createItem').show();
        $('#buttonWrapper').hide();
        $('#create').hide();
        $('#ctab').html(rows);
        $('#search').hide();
      }
    });
  }
  function renderSearchTable(idx, cnt){
    $.getJSON("/caleb/api.php/character/search/?idx="+idx+"&cnt="+cnt+"&pstr="+$('#searchbar').val() , function(data, status){
        if (status == "success"){
          characters = data;
          var rows = '<tr><th>Name</th><th>Race</th><th>Class</th><th>Edit</th></tr>';
          $.each (data, function(index, item){
          rows += '<tr><td>' + item.pname + '</td><td>' + item.race + '</td><td>' + item.guild + '</td><td><button onclick="renderEdit('+ index +')">Edit</button></td><td><button onclick="deleteCharacter('+ item.id +')">delete</button></td></tr>';
        });
        $('#ctab').html(rows);
        $('#itemNumbers').html((idx+1) + '-' + (idx + cnt));
       }
    });
  }
 </script>
</head>
<body>
  <div id="head-wrap">
    <button onclick="renderItemTable()">Items</button>
    <button onclick="renderTable(index, count)">Characters</button>
    <div id="search">
      <input type="text" id="searchbar" onkeyup="renderSearchTable(index, count)">
    </div>
    </div>

  <table id="ctab" style="width:100%" class="table table-striped">
  </table>

  <div id="create">
    <button onclick="createCharacter()">Create character</button>
  </div>
  <div id="createItem">
    <button onclick="createItm()">Create Item</button>
  </div>
  <div id="buttonWrapper">
    <button type="button" onclick="previous()" id="prev">Previous</button>
    <label id="itemNumbers"></label>
    <button type="button" onclick="next()" id="next">Next</button> 
  </div>

  <div id="overlay">
  </div>
  
  <div id="edit">
    <input type="text" id="pname">
    
    <input type="text" id="race">
   
    <input type="text" id="guild">
    <select class="custom-select custom-select-lg" id="itemList" name="items">
      <option value="null">Add Item</option>
    </select>

      <button onclick="closeEdit()">Close</button>
    <button onclick="save()">Save</button>
    <label id="message"></label>
  </div>

  <div id="editItem">
    <input type="text" id="iname">
    <button onclick="closeEdit()">Close</button>
    <button onclick="saveItem()">Save</button>
    <label id="imessage"></label>
  </div>

  <div id="createPerson">
    <div class="d-flex flex-column">
      <label>Name</label>
      <input type="text" id="cpname">

      <label>Race</label>
      <input type="text" id="crace">

      <label>Class</label>
      <input type="text" id="cguild">
  </div>  
    <select class="custom-select custom-select-lg" id="items" name="itemList">
      <option value="null">Starting Item</option>
    </select>
        <button onclick="closeEdit()">Close</button>
    <button onclick="create()">Save</button>
    <label id="message"></label>
  </div>

  <div id="createItm">
    <input type="text" id="ciname">
    <button onclick="closeEdit()">Close</button>
    <button onclick="createItem()">Save</button>
    <label id="imessage"></label>
  </div>

  <div id="readCharacter">
    
    <label id="rpname"></label>
    <label id="rrace"></label>
    <label id="rguild"></label>
    <label id="charItms">Items: </label>
    <button type="button" class="btn" onclick="closeEdit()">Close</button>
  </div>
</body>
</html>